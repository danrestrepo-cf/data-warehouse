name: transaction_junk_dim
primary_source_table: staging.history_octane.proposal
primary_key:
- dwid
columns:
  dwid:
    data_type: BIGINT
    update_flag: false
  data_source_dwid:
    data_type: BIGINT
    update_flag: true
  edw_created_datetime:
    data_type: TIMESTAMPTZ
    update_flag: false
  edw_modified_datetime:
    data_type: TIMESTAMPTZ
    update_flag: true
  etl_batch_id:
    data_type: TEXT
    update_flag: true
  data_source_integration_columns:
    data_type: TEXT
    update_flag: true
  data_source_integration_id:
    data_type: TEXT
    update_flag: false
  data_source_modified_datetime:
    data_type: TIMESTAMPTZ
    update_flag: false
  piggyback_flag:
    data_type: BOOLEAN
    source:
      calculation:
        string: $1 = 'COMBO'
        using:
          - primary_source_table.columns.prp_structure_type
    update_flag: true
  mi_required_flag:
    data_type: BOOLEAN
    source:
      field: primary_source_table.columns.prp_mi_required
    update_flag: true
  is_test_loan_flag:
    data_type: BOOLEAN
    source:
      field: primary_source_table.foreign_keys.fk_proposal_1.columns.d_test_loan
    update_flag: true
  structure:
    data_type: VARCHAR(1024)
    source:
      field: primary_source_table.foreign_keys.fkt_prp_structure_type.columns.value
    update_flag: true
  loan_purpose:
    data_type: VARCHAR(1024)
    source:
      field: primary_source_table.foreign_keys.fkt_prp_loan_purpose_type.columns.value
    update_flag: true
  structure_code:
    data_type: VARCHAR(128)
    source:
      field: primary_source_table.columns.prp_structure_type
    update_flag: true
  loan_purpose_code:
    data_type: VARCHAR(128)
    source:
      field: primary_source_table.columns.prp_loan_purpose_type
    update_flag: true
etls:
  SP-200020:
    input_type: table
    output_type: insert_update
    hardcoded_data_source: Octane
    json_output_field: data_source_integration_id
    insert_update_keys:
      - data_source_integration_id
    container_memory: 2048
    input_sql: |-
      SELECT transaction_junk_dim_new_records.data_source_integration_columns
           , transaction_junk_dim_new_records.data_source_integration_id
           , transaction_junk_dim_new_records.edw_created_datetime
           , transaction_junk_dim_new_records.edw_modified_datetime
           , transaction_junk_dim_new_records.data_source_modified_datetime
           , transaction_junk_dim_new_records.is_test_loan_flag
           , transaction_junk_dim_new_records.loan_purpose
           , transaction_junk_dim_new_records.structure_code
           , transaction_junk_dim_new_records.mi_required_flag
           , transaction_junk_dim_new_records.loan_purpose_code
           , transaction_junk_dim_new_records.structure
           , transaction_junk_dim_new_records.piggyback_flag
      FROM (
          SELECT 'is_test_loan_flag' || '~' || 'loan_purpose' || '~' || 'structure_code' || '~' || 'mi_required_flag' || '~' ||
                 'loan_purpose_code' || '~' || 'structure' || '~' || 'data_source_dwid' || '~' || 'piggyback_flag' AS data_source_integration_columns
               , COALESCE( CAST( t1441.d_test_loan AS TEXT ), '<NULL>' ) || '~' ||
                 COALESCE( CAST( t649.value AS TEXT ), '<NULL>' ) || '~' ||
                 COALESCE( CAST( primary_table.prp_structure_type AS TEXT ), '<NULL>' ) || '~' ||
                 COALESCE( CAST( primary_table.prp_mi_required AS TEXT ), '<NULL>' ) || '~' ||
                 COALESCE( CAST( primary_table.prp_loan_purpose_type AS TEXT ), '<NULL>' ) || '~' ||
                 COALESCE( CAST( t661.value AS TEXT ), '<NULL>' ) || '~' ||
                 COALESCE( CAST( 1 AS TEXT ), '<NULL>' ) || '~' ||
                 COALESCE( CAST( primary_table.prp_structure_type = 'COMBO' AS TEXT ), '<NULL>' ) AS data_source_integration_id
               , NOW( ) AS edw_created_datetime
               , NOW( ) AS edw_modified_datetime
               , MAX( primary_table.data_source_updated_datetime ) AS data_source_modified_datetime
               , t1441.d_test_loan AS is_test_loan_flag
               , t649.value AS loan_purpose
               , primary_table.prp_structure_type AS structure_code
               , primary_table.prp_mi_required AS mi_required_flag
               , primary_table.prp_loan_purpose_type AS loan_purpose_code
               , t661.value AS structure
               , primary_table.prp_structure_type = 'COMBO' AS piggyback_flag
          FROM (
              SELECT <<proposal_partial_load_condition>> AS include_record
                   , proposal.*
              FROM history_octane.proposal
              LEFT JOIN history_octane.proposal AS history_records
                        ON proposal.prp_pid = history_records.prp_pid
                            AND proposal.data_source_updated_datetime < history_records.data_source_updated_datetime
              WHERE history_records.prp_pid IS NULL
          ) AS primary_table

          INNER JOIN (
              SELECT *
              FROM (
                  SELECT <<deal_partial_load_condition>> AS include_record
                       , deal.*
                  FROM history_octane.deal
                  LEFT JOIN history_octane.deal AS history_records
                            ON deal.d_pid = history_records.d_pid
                                AND deal.data_source_updated_datetime < history_records.data_source_updated_datetime
                  WHERE history_records.d_pid IS NULL
              ) AS primary_table
          ) AS t1441
                     ON primary_table.prp_deal_pid = t1441.d_pid

          INNER JOIN (
              SELECT *
              FROM (
                  SELECT <<loan_purpose_type_partial_load_condition>> AS include_record
                       , loan_purpose_type.*
                  FROM history_octane.loan_purpose_type
                  LEFT JOIN history_octane.loan_purpose_type AS history_records
                            ON loan_purpose_type.code = history_records.code
                                AND loan_purpose_type.data_source_updated_datetime < history_records.data_source_updated_datetime
                  WHERE history_records.code IS NULL
              ) AS primary_table
          ) AS t649
                     ON primary_table.prp_loan_purpose_type = t649.code

          INNER JOIN (
              SELECT *
              FROM (
                  SELECT <<proposal_structure_type_partial_load_condition>> AS include_record
                       , proposal_structure_type.*
                  FROM history_octane.proposal_structure_type
                  LEFT JOIN history_octane.proposal_structure_type AS history_records
                            ON proposal_structure_type.code = history_records.code
                                AND proposal_structure_type.data_source_updated_datetime < history_records.data_source_updated_datetime
                  WHERE history_records.code IS NULL
              ) AS primary_table
          ) AS t661
                     ON primary_table.prp_structure_type = t661.code
          WHERE GREATEST( primary_table.include_record, t1441.include_record, t649.include_record, t661.include_record ) IS TRUE
          GROUP BY t1441.d_test_loan, primary_table.prp_structure_type, primary_table.prp_mi_required, t661.value
                 , primary_table.prp_structure_type, t649.value, primary_table.prp_loan_purpose_type
      ) AS transaction_junk_dim_new_records
      LEFT JOIN star_loan.transaction_junk_dim
                ON transaction_junk_dim.data_source_integration_id = transaction_junk_dim_new_records.data_source_integration_id
      WHERE transaction_junk_dim.dwid IS NULL;
next_etls:
  - SP-300001-insert-update
