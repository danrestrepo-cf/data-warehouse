name: employee_user_details
primary_source_table: staging.history_octane.lender_user
primary_key:
- octane_username
columns:
  parent_node_id:
    data_type: BIGINT
    update_flag: true
  parent_node_name:
    data_type: VARCHAR(256)
    update_flag: true
  company_user_id:
    data_type: VARCHAR(32)
    update_flag: true
  octane_username:
    data_type: VARCHAR(32)
    update_flag: false
  first_name:
    data_type: VARCHAR(32)
    update_flag: true
  last_name:
    data_type: VARCHAR(32)
    update_flag: true
  professional_title:
    data_type: VARCHAR(128)
    update_flag: true
  email:
    data_type: VARCHAR(256)
    update_flag: true
  hire_date:
    data_type: DATE
    update_flag: true
  termination_date:
    data_type: DATE
    update_flag: true
  is_active_hub_user:
    data_type: BOOLEAN
    update_flag: true
etls:
  SP-400001-insert-update:
    input_type: table
    output_type: insert_update
    hardcoded_data_source: Octane
    json_output_field: octane_username
    insert_update_keys:
    - octane_username
    container_memory: 2048
    input_sql: |-
      --SP-400001-insert-update
      SELECT parent_org_node.on_org_node_id AS parent_node_id
           , parent_org_node.on_org_node_name_latest AS parent_node_name
           , lender_user.lu_company_user_id AS company_user_id
           , lender_user.lu_username AS octane_username
           , lender_user.lu_first_name AS first_name
           , lender_user.lu_last_name AS last_name
           , lender_user.lu_title AS professional_title
           , lender_user.lu_email AS email
           , lender_user.lu_hire_date AS hire_date
           , lender_user.lu_termination_date AS termination_date
           , (lender_user.lu_lender_user_status_type <> 'INACTIVE' AND lender_user.lu_hub_directory) AS is_active_hub_user
      FROM (
          SELECT lender_user.*
          FROM history_octane.lender_user
          LEFT JOIN history_octane.lender_user AS history_records
                    ON lender_user.lu_pid = history_records.lu_pid
                        AND lender_user.data_source_updated_datetime < history_records.data_source_updated_datetime
          WHERE history_records.lu_pid IS NULL
            AND NOT lender_user.data_source_deleted_flag
            AND lender_user.lu_lender_user_type = 'EMPLOYEE'
      ) AS lender_user
      JOIN (
          SELECT org_node.*
          FROM history_octane.org_node
          LEFT JOIN history_octane.org_node AS history_records
                    ON org_node.on_pid = history_records.on_pid
                        AND org_node.data_source_updated_datetime < history_records.data_source_updated_datetime
          WHERE history_records.on_pid IS NULL
            AND NOT org_node.data_source_deleted_flag
      ) AS child_org_node
           ON child_org_node.on_lender_user_pid = lender_user.lu_pid
      LEFT JOIN (
          SELECT org_node_version.*
          FROM history_octane.org_node_version
          LEFT JOIN history_octane.org_node_version AS history_records
                    ON org_node_version.onv_pid = history_records.onv_pid
                        AND org_node_version.data_source_updated_datetime < history_records.data_source_updated_datetime
          WHERE history_records.onv_pid IS NULL
            AND NOT org_node_version.data_source_deleted_flag
            AND CURRENT_DATE BETWEEN org_node_version.onv_from_date
              AND COALESCE( org_node_version.onv_through_date, CURRENT_DATE ) -- current version
      ) AS org_node_version
                ON child_org_node.on_pid = org_node_version.onv_org_node_pid
      LEFT JOIN (
          SELECT org_node.*
          FROM history_octane.org_node
          LEFT JOIN history_octane.org_node AS history_records
                    ON org_node.on_pid = history_records.on_pid
                        AND org_node.data_source_updated_datetime < history_records.data_source_updated_datetime
          WHERE history_records.on_pid IS NULL
            AND NOT org_node.data_source_deleted_flag
      ) AS parent_org_node
                ON org_node_version.onv_parent_org_node_pid = parent_org_node.on_pid;
  SP-400001-delete:
    input_type: table
    output_type: delete
    json_output_field: octane_username
    delete_keys:
    - octane_username
    container_memory: 2048
    input_sql: |-
      --SP-400001-delete
      SELECT employee_user_details.octane_username
      FROM data_mart_business_applications.employee_user_details
      LEFT JOIN (
          SELECT *
          FROM (
              SELECT lender_user.*
              FROM history_octane.lender_user
              LEFT JOIN history_octane.lender_user AS history_records
                        ON lender_user.lu_pid = history_records.lu_pid
                            AND lender_user.data_source_updated_datetime < history_records.data_source_updated_datetime
              WHERE history_records.lu_pid IS NULL
                AND NOT lender_user.data_source_deleted_flag
                AND lender_user.lu_lender_user_type = 'EMPLOYEE'
          ) AS lender_user
          JOIN (
              SELECT org_node.*
              FROM history_octane.org_node
              LEFT JOIN history_octane.org_node AS history_records
                        ON org_node.on_pid = history_records.on_pid
                            AND org_node.data_source_updated_datetime < history_records.data_source_updated_datetime
              WHERE history_records.on_pid IS NULL
                AND NOT org_node.data_source_deleted_flag
          ) AS child_org_node
               ON child_org_node.on_lender_user_pid = lender_user.lu_pid
      ) AS current_data
                ON employee_user_details.octane_username = current_data.lu_username
      WHERE current_data.lu_pid IS NULL;
