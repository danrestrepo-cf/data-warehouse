--
-- EDW | DML changes - Octane Schema changes for 2021.5.3.0 (5/21/21)
-- https://app.asana.com/0/0/1200353301584120
--

DO
$$
    DECLARE
        -- Variables for inserting new records into edw_field_definition
        edw_table_definition_staging_proposal_summary_dwid     BIGINT;
        edw_table_definition_history_proposal_summary_dwid     BIGINT;
        staging_ps_any_hoa_certification_fee_dwid              BIGINT;

        -- Variables for inserting new records into table_output_field
        proposal_summary_config_table_output_step_dwid         BIGINT;
        proposal_summary_config_table_output_field_field_order BIGINT;

        -- Variables for updating records in table_input_step
        proposal_summary_config_process_dwid                   BIGINT;
        place_config_process_dwid                              BIGINT;

    BEGIN
        -- populate dwid variables
        edw_table_definition_staging_proposal_summary_dwid = (
            SELECT dwid
            FROM mdi.edw_table_definition
            WHERE schema_name = 'staging_octane'
              AND table_name = 'proposal_summary'
        );
        edw_table_definition_history_proposal_summary_dwid = (
            SELECT dwid
            FROM mdi.edw_table_definition
            WHERE schema_name = 'history_octane'
              AND table_name = 'proposal_summary'
        );

        proposal_summary_config_process_dwid = (
            SELECT dwid
            FROM mdi.process
            WHERE process.name = 'SP-100329'
        );

        place_config_process_dwid = (
            SELECT dwid
            FROM mdi.process
            WHERE process.name = 'SP-100012'
        );

        proposal_summary_config_table_output_step_dwid = (
            SELECT table_output_step.dwid
            FROM mdi.table_output_step
            WHERE process_dwid = proposal_summary_config_process_dwid
        );

        proposal_summary_config_table_output_field_field_order = (
            SELECT MAX( table_output_field.field_order )
            FROM mdi.table_output_field
            WHERE table_output_field.table_output_step_dwid = proposal_summary_config_table_output_step_dwid
        );

        -- insert new field definition rows for proposal_summary.ps_any_hoa_certification_fee
        INSERT
        INTO mdi.edw_field_definition (edw_table_definition_dwid, field_name, key_field_flag)
        VALUES (edw_table_definition_staging_proposal_summary_dwid, 'ps_any_hoa_certification_fee', FALSE)
        RETURNING dwid INTO staging_ps_any_hoa_certification_fee_dwid;

        INSERT
        INTO mdi.edw_field_definition (edw_table_definition_dwid, field_name, key_field_flag, source_edw_field_definition_dwid)
        VALUES (edw_table_definition_history_proposal_summary_dwid, 'ps_any_hoa_certification_fee', FALSE, staging_ps_any_hoa_certification_fee_dwid);

        -- add proposal_summary.ps_any_hoa_certification_fee field to table_input_step SQL for staging -> history ETL
        UPDATE mdi.table_input_step
        SET sql = 'SELECT staging_table.ps_pid, staging_table.ps_version, staging_table.ps_proposal_pid, staging_table.ps_subject_property_city, staging_table.ps_subject_property_country, staging_table.ps_subject_property_postal_code, staging_table.ps_subject_property_state, staging_table.ps_subject_property_street1, staging_table.ps_subject_property_street2, staging_table.ps_note_rate_percent_main, staging_table.ps_note_rate_percent_piggyback, staging_table.ps_initial_note_rate_percent_main, staging_table.ps_initial_note_rate_percent_piggyback, staging_table.ps_base_loan_amount_main, staging_table.ps_base_loan_amount_piggyback, staging_table.ps_loan_amount_main, staging_table.ps_loan_amount_piggyback, staging_table.ps_product_special_program_type_main, staging_table.ps_product_special_program_type_piggyback, staging_table.ps_investor_pid_main, staging_table.ps_investor_pid_piggyback, staging_table.ps_product_fnm_community_lending_product_type_main, staging_table.ps_product_fnm_community_lending_product_type_piggyback, staging_table.ps_product_fre_community_program_type_main, staging_table.ps_product_fre_community_program_type_piggyback, staging_table.ps_mortgage_type_main, staging_table.ps_mortgage_type_piggyback, staging_table.ps_b1_first_name, staging_table.ps_c1_first_name, staging_table.ps_b2_first_name, staging_table.ps_b1_last_name, staging_table.ps_c1_last_name, staging_table.ps_b2_last_name, staging_table.ps_b1_middle_name, staging_table.ps_c1_middle_name, staging_table.ps_b2_middle_name, staging_table.ps_b1_preferred_first_name, staging_table.ps_b2_preferred_first_name, staging_table.ps_c1_preferred_first_name, staging_table.ps_b1_birth_date, staging_table.ps_c1_birth_date, staging_table.ps_b1_monthly_income, staging_table.ps_c1_monthly_income, staging_table.ps_b2_monthly_income, staging_table.ps_b1_has_business_income, staging_table.ps_c1_has_business_income, staging_table.ps_b2_has_business_income, staging_table.ps_b1_citizenship_residency_type, staging_table.ps_c1_citizenship_residency_type, staging_table.ps_b2_citizenship_residency_type, staging_table.ps_b1_hmda_ethnicity_2017_type, staging_table.ps_c1_hmda_ethnicity_2017_type, staging_table.ps_b2_hmda_ethnicity_2017_type, staging_table.ps_b1_decision_credit_score, staging_table.ps_c1_decision_credit_score, staging_table.ps_b2_decision_credit_score, staging_table.ps_b1_gender_type, staging_table.ps_c1_gender_type, staging_table.ps_b2_gender_type, staging_table.ps_b1_hmda_race_2017_type, staging_table.ps_c1_hmda_race_2017_type, staging_table.ps_b2_hmda_race_2017_type, staging_table.ps_any_lender_employee_borrower, staging_table.ps_upfront_mi_percent_main, staging_table.ps_upfront_mi_percent_piggyback, staging_table.ps_primary_application_name, staging_table.ps_investor_loan_id_main, staging_table.ps_investor_loan_id_piggyback, staging_table.ps_initial_servicer_investor_loan_id_main, staging_table.ps_initial_servicer_investor_loan_id_piggyback, staging_table.ps_current_servicer_investor_loan_id_main, staging_table.ps_current_servicer_investor_loan_id_piggyback, staging_table.ps_offering_id_main, staging_table.ps_offering_id_piggyback, staging_table.ps_proposal_structure_type, staging_table.ps_loan_maturity_date_main, staging_table.ps_loan_maturity_date_piggyback, staging_table.ps_ltv_ratio_percent_main, staging_table.ps_ltv_ratio_percent_piggyback, staging_table.ps_cltv_ratio_percent, staging_table.ps_hcltv_ratio_percent, staging_table.ps_hcltv_applicable, staging_table.ps_debt_ratio_percent, staging_table.ps_housing_ratio_percent, staging_table.ps_property_category_type, staging_table.ps_any_first_time_home_buyer, staging_table.ps_primary_housing_expense_amount, staging_table.ps_non_primary_housing_expense_amount, staging_table.ps_income_monthly_total_amount, staging_table.ps_asset_total_amount, staging_table.ps_liquid_asset_total_amount, staging_table.ps_liability_unpaid_balance_total_amount, staging_table.ps_liability_monthly_payment_total_amount, staging_table.ps_monthly_pitia_amount, staging_table.ps_cash_from_borrower_amount_signed, staging_table.ps_proposed_monthly_housing_and_debt_amount, staging_table.ps_funding_date_main, staging_table.ps_funding_date_piggyback, staging_table.ps_interim_funder_company_name, staging_table.ps_interim_funder_mers_org_id, staging_table.ps_funding_scheduled_release_date_main, staging_table.ps_funding_scheduled_release_date_piggyback, staging_table.ps_uuts_aus_recommendation_description, staging_table.ps_interest_rate_fee_amount_signed, staging_table.ps_interest_rate_fee_amount_signed_main, staging_table.ps_interest_rate_fee_amount_signed_piggyback, staging_table.ps_origination_fees_amount_signed, staging_table.ps_origination_fees_amount_signed_main, staging_table.ps_origination_fees_amount_signed_piggyback, staging_table.ps_any_escrow_waived, staging_table.ps_initial_rate_adjustment_date_main, staging_table.ps_initial_rate_adjustment_date_piggyback, staging_table.ps_tolerance_cure_amount_signed, staging_table.ps_tolerance_cure_amount_signed_main, staging_table.ps_tolerance_cure_amount_signed_piggyback, staging_table.ps_subject_property_existing_subordinate_2nd, staging_table.ps_subject_property_subordinate_2nd_creditor_pid, staging_table.ps_subject_property_existing_subordinate_3rd, staging_table.ps_subject_property_subordinate_3rd_creditor_pid, staging_table.ps_total_monthly_solar_lease_payments_amount, staging_table.ps_total_debt_payoff_amount, staging_table.ps_total_new_subordinate_financing_amount, staging_table.ps_total_grant_amount, staging_table.ps_any_third_party_community_second, staging_table.ps_any_grant_program, staging_table.ps_initial_loan_estimate_loan_amount_main, staging_table.ps_initial_loan_estimate_loan_amount_piggyback, staging_table.ps_any_mortgage_credit_certificate, staging_table.ps_debt_ratio_excluding_mi_percent, staging_table.ps_fund_source_type_main, staging_table.ps_fund_source_type_piggyback, staging_table.ps_mortgage_credit_certificate_issuer_pid, staging_table.ps_subject_property_new_subordinate_2nd, staging_table.ps_subject_property_new_subordinate_3rd, staging_table.ps_any_borrower_self_employed, staging_table.ps_fha_section_of_act_coarse_type_main, staging_table.ps_fha_section_of_act_coarse_type_piggyback, staging_table.ps_fha_special_program_type_main, staging_table.ps_fha_special_program_type_piggyback, staging_table.ps_product_pid_main, staging_table.ps_product_pid_piggyback, staging_table.ps_net_origination_charge_main, staging_table.ps_net_origination_charge_piggyback, staging_table.ps_household_income_guideline_percent, staging_table.ps_applicant_count, staging_table.ps_early_wire_total_charge_amount_main, staging_table.ps_early_wire_total_charge_amount_piggyback, staging_table.ps_funding_scheduled_release_date_auto_compute_main, staging_table.ps_funding_scheduled_release_date_auto_compute_piggyback, staging_table.ps_any_hoa_certification_fee, FALSE as data_source_deleted_flag, now() AS data_source_updated_datetime
FROM staging_octane.proposal_summary staging_table
LEFT JOIN history_octane.proposal_summary history_table on staging_table.ps_pid = history_table.ps_pid and staging_table.ps_version = history_table.ps_version
WHERE history_table.ps_pid is NULL
UNION ALL
SELECT history_table.ps_pid, history_table.ps_version+1, history_table.ps_proposal_pid, history_table.ps_subject_property_city, history_table.ps_subject_property_country, history_table.ps_subject_property_postal_code, history_table.ps_subject_property_state, history_table.ps_subject_property_street1, history_table.ps_subject_property_street2, history_table.ps_note_rate_percent_main, history_table.ps_note_rate_percent_piggyback, history_table.ps_initial_note_rate_percent_main, history_table.ps_initial_note_rate_percent_piggyback, history_table.ps_base_loan_amount_main, history_table.ps_base_loan_amount_piggyback, history_table.ps_loan_amount_main, history_table.ps_loan_amount_piggyback, history_table.ps_product_special_program_type_main, history_table.ps_product_special_program_type_piggyback, history_table.ps_investor_pid_main, history_table.ps_investor_pid_piggyback, history_table.ps_product_fnm_community_lending_product_type_main, history_table.ps_product_fnm_community_lending_product_type_piggyback, history_table.ps_product_fre_community_program_type_main, history_table.ps_product_fre_community_program_type_piggyback, history_table.ps_mortgage_type_main, history_table.ps_mortgage_type_piggyback, history_table.ps_b1_first_name, history_table.ps_c1_first_name, history_table.ps_b2_first_name, history_table.ps_b1_last_name, history_table.ps_c1_last_name, history_table.ps_b2_last_name, history_table.ps_b1_middle_name, history_table.ps_c1_middle_name, history_table.ps_b2_middle_name, history_table.ps_b1_preferred_first_name, history_table.ps_b2_preferred_first_name, history_table.ps_c1_preferred_first_name, history_table.ps_b1_birth_date, history_table.ps_c1_birth_date, history_table.ps_b1_monthly_income, history_table.ps_c1_monthly_income, history_table.ps_b2_monthly_income, history_table.ps_b1_has_business_income, history_table.ps_c1_has_business_income, history_table.ps_b2_has_business_income, history_table.ps_b1_citizenship_residency_type, history_table.ps_c1_citizenship_residency_type, history_table.ps_b2_citizenship_residency_type, history_table.ps_b1_hmda_ethnicity_2017_type, history_table.ps_c1_hmda_ethnicity_2017_type, history_table.ps_b2_hmda_ethnicity_2017_type, history_table.ps_b1_decision_credit_score, history_table.ps_c1_decision_credit_score, history_table.ps_b2_decision_credit_score, history_table.ps_b1_gender_type, history_table.ps_c1_gender_type, history_table.ps_b2_gender_type, history_table.ps_b1_hmda_race_2017_type, history_table.ps_c1_hmda_race_2017_type, history_table.ps_b2_hmda_race_2017_type, history_table.ps_any_lender_employee_borrower, history_table.ps_upfront_mi_percent_main, history_table.ps_upfront_mi_percent_piggyback, history_table.ps_primary_application_name, history_table.ps_investor_loan_id_main, history_table.ps_investor_loan_id_piggyback, history_table.ps_initial_servicer_investor_loan_id_main, history_table.ps_initial_servicer_investor_loan_id_piggyback, history_table.ps_current_servicer_investor_loan_id_main, history_table.ps_current_servicer_investor_loan_id_piggyback, history_table.ps_offering_id_main, history_table.ps_offering_id_piggyback, history_table.ps_proposal_structure_type, history_table.ps_loan_maturity_date_main, history_table.ps_loan_maturity_date_piggyback, history_table.ps_ltv_ratio_percent_main, history_table.ps_ltv_ratio_percent_piggyback, history_table.ps_cltv_ratio_percent, history_table.ps_hcltv_ratio_percent, history_table.ps_hcltv_applicable, history_table.ps_debt_ratio_percent, history_table.ps_housing_ratio_percent, history_table.ps_property_category_type, history_table.ps_any_first_time_home_buyer, history_table.ps_primary_housing_expense_amount, history_table.ps_non_primary_housing_expense_amount, history_table.ps_income_monthly_total_amount, history_table.ps_asset_total_amount, history_table.ps_liquid_asset_total_amount, history_table.ps_liability_unpaid_balance_total_amount, history_table.ps_liability_monthly_payment_total_amount, history_table.ps_monthly_pitia_amount, history_table.ps_cash_from_borrower_amount_signed, history_table.ps_proposed_monthly_housing_and_debt_amount, history_table.ps_funding_date_main, history_table.ps_funding_date_piggyback, history_table.ps_interim_funder_company_name, history_table.ps_interim_funder_mers_org_id, history_table.ps_funding_scheduled_release_date_main, history_table.ps_funding_scheduled_release_date_piggyback, history_table.ps_uuts_aus_recommendation_description, history_table.ps_interest_rate_fee_amount_signed, history_table.ps_interest_rate_fee_amount_signed_main, history_table.ps_interest_rate_fee_amount_signed_piggyback, history_table.ps_origination_fees_amount_signed, history_table.ps_origination_fees_amount_signed_main, history_table.ps_origination_fees_amount_signed_piggyback, history_table.ps_any_escrow_waived, history_table.ps_initial_rate_adjustment_date_main, history_table.ps_initial_rate_adjustment_date_piggyback, history_table.ps_tolerance_cure_amount_signed, history_table.ps_tolerance_cure_amount_signed_main, history_table.ps_tolerance_cure_amount_signed_piggyback, history_table.ps_subject_property_existing_subordinate_2nd, history_table.ps_subject_property_subordinate_2nd_creditor_pid, history_table.ps_subject_property_existing_subordinate_3rd, history_table.ps_subject_property_subordinate_3rd_creditor_pid, history_table.ps_total_monthly_solar_lease_payments_amount, history_table.ps_total_debt_payoff_amount, history_table.ps_total_new_subordinate_financing_amount, history_table.ps_total_grant_amount, history_table.ps_any_third_party_community_second, history_table.ps_any_grant_program, history_table.ps_initial_loan_estimate_loan_amount_main, history_table.ps_initial_loan_estimate_loan_amount_piggyback, history_table.ps_any_mortgage_credit_certificate, history_table.ps_debt_ratio_excluding_mi_percent, history_table.ps_fund_source_type_main, history_table.ps_fund_source_type_piggyback, history_table.ps_mortgage_credit_certificate_issuer_pid, history_table.ps_subject_property_new_subordinate_2nd, history_table.ps_subject_property_new_subordinate_3rd, history_table.ps_any_borrower_self_employed, history_table.ps_fha_section_of_act_coarse_type_main, history_table.ps_fha_section_of_act_coarse_type_piggyback, history_table.ps_fha_special_program_type_main, history_table.ps_fha_special_program_type_piggyback, history_table.ps_product_pid_main, history_table.ps_product_pid_piggyback, history_table.ps_net_origination_charge_main, history_table.ps_net_origination_charge_piggyback, history_table.ps_household_income_guideline_percent, history_table.ps_applicant_count, history_table.ps_early_wire_total_charge_amount_main, history_table.ps_early_wire_total_charge_amount_piggyback, history_table.ps_funding_scheduled_release_date_auto_compute_main, history_table.ps_funding_scheduled_release_date_auto_compute_piggyback, history_table.ps_any_hoa_certification_fee, TRUE as data_source_deleted_flag, now() AS data_source_updated_datetime
FROM history_octane.proposal_summary history_table
LEFT JOIN staging_octane.proposal_summary staging_table on staging_table.ps_pid = history_table.ps_pid
WHERE staging_table.ps_pid is NULL
  AND not exists (select 1 from history_octane.proposal_summary deleted_records where deleted_records.ps_pid = history_table.ps_pid and deleted_records.data_source_deleted_flag = True)'
        WHERE mdi.table_input_step.process_dwid = proposal_summary_config_process_dwid;

        -- insert new table_output_field row for proposal_summary.ps_any_hoa_certification_fee for staging -> history ETL
        INSERT
        INTO mdi.table_output_field (table_output_step_dwid, database_field_name, database_stream_name, field_order, is_sensitive)
        VALUES (proposal_summary_config_table_output_step_dwid, 'ps_any_hoa_certification_fee', 'ps_any_hoa_certification_fee', proposal_summary_config_table_output_field_field_order + 1, FALSE);

        -- update table_input_step for 2021.5.2.0 Octane deployment, accidentally omitted from 2021.5.2.1 EDW release
        UPDATE mdi.table_input_step
        SET sql = '--finding records to insert into history_octane.place
SELECT staging_table.pl_pid, staging_table.pl_version, staging_table.pl_proposal_pid, staging_table.pl_subject_property, staging_table.pl_acquisition_date, staging_table.pl_construction_improvement_costs_amount, staging_table.pl_financed_units_count, staging_table.pl_unit_count, staging_table.pl_land_estimated_value_amount, staging_table.pl_land_original_cost_amount, staging_table.pl_leasehold_expiration_date, staging_table.pl_legal_description_type, staging_table.pl_legal_description, staging_table.pl_property_tax_id, staging_table.pl_legal_lot, staging_table.pl_legal_block, staging_table.pl_legal_section, staging_table.pl_project_name, staging_table.pl_cpm_project_id, staging_table.pl_acquisition_cost_amount, staging_table.pl_county_pid, staging_table.pl_sub_jurisdiction_name, staging_table.pl_recording_district_name, staging_table.pl_project_classification_type, staging_table.pl_property_category_type, staging_table.pl_property_rights_type, staging_table.pl_refinance_total_improvement_costs_amount, staging_table.pl_refinance_improvements_type, staging_table.pl_refinance_proposed_improvements_description, staging_table.pl_structure_built_year, staging_table.pl_structure_built_month, staging_table.pl_title_manner_held_type, staging_table.pl_title_manner_held_description, staging_table.pl_building_status_type, staging_table.pl_construction_conversion, staging_table.pl_native_american_lands_type, staging_table.pl_community_land_trust, staging_table.pl_inclusionary_zoning, staging_table.pl_unique_dwelling_type, staging_table.pl_living_unit_count, staging_table.pl_project_design_type, staging_table.pl_city, staging_table.pl_country, staging_table.pl_postal_code, staging_table.pl_state, staging_table.pl_street1, staging_table.pl_street2, staging_table.pl_street_tbd, staging_table.pl_landlord_first_name, staging_table.pl_landlord_last_name, staging_table.pl_landlord_middle_name, staging_table.pl_landlord_name_suffix, staging_table.pl_landlord_company_name, staging_table.pl_landlord_title, staging_table.pl_landlord_office_phone, staging_table.pl_landlord_office_phone_extension, staging_table.pl_landlord_mobile_phone, staging_table.pl_landlord_email, staging_table.pl_landlord_fax, staging_table.pl_landlord_city, staging_table.pl_landlord_country, staging_table.pl_landlord_postal_code, staging_table.pl_landlord_state, staging_table.pl_landlord_street1, staging_table.pl_landlord_street2, staging_table.pl_management_first_name, staging_table.pl_management_last_name, staging_table.pl_management_middle_name, staging_table.pl_management_name_suffix, staging_table.pl_management_company_name, staging_table.pl_management_title, staging_table.pl_management_office_phone, staging_table.pl_management_office_phone_extension, staging_table.pl_management_mobile_phone, staging_table.pl_management_email, staging_table.pl_management_fax, staging_table.pl_management_city, staging_table.pl_management_country, staging_table.pl_management_postal_code, staging_table.pl_management_state, staging_table.pl_management_street1, staging_table.pl_management_street2, staging_table.pl_property_insurance_amount_input_type, staging_table.pl_property_tax_amount_input_type, staging_table.pl_annual_property_insurance_amount, staging_table.pl_annual_property_tax_amount, staging_table.pl_monthly_property_insurance_amount, staging_table.pl_monthly_hoa_amount, staging_table.pl_monthly_mi_amount, staging_table.pl_monthly_property_tax_amount, staging_table.pl_monthly_lease_ground_rent_amount, staging_table.pl_monthly_rent_amount, staging_table.pl_monthly_obligation_amount, staging_table.pl_use_proposed_property_usage, staging_table.pl_property_usage_type, staging_table.pl_property_value_amount, staging_table.pl_reo_disposition_status_type, staging_table.pl_auto_geocode, staging_table.pl_auto_geocode_exception, staging_table.pl_msa_code, staging_table.pl_state_fips, staging_table.pl_county_fips, staging_table.pl_census_tract, staging_table.pl_mh_make, staging_table.pl_mh_model, staging_table.pl_mh_length, staging_table.pl_mh_width, staging_table.pl_mh_manufacturer, staging_table.pl_mh_serial_number, staging_table.pl_mh_hud_label_number, staging_table.pl_mh_certificate_of_title_issued, staging_table.pl_mh_certificate_of_title_number, staging_table.pl_mh_certificate_of_title_type, staging_table.pl_mh_loan_purpose_type, staging_table.pl_mh_anchored, staging_table.pl_coop_company_name, staging_table.pl_coop_building_name, staging_table.pl_coop_vacant_units, staging_table.pl_coop_proprietary_lease_date, staging_table.pl_coop_assignment_lease_date, staging_table.pl_coop_existing_company_laws_state, staging_table.pl_coop_shares_being_purchased, staging_table.pl_coop_attorney_in_fact, staging_table.pl_coop_stock_certificate_number, staging_table.pl_coop_apartment_unit, staging_table.pl_rental, staging_table.pl_underwriter_comments, staging_table.pl_lava_zone_type, staging_table.pl_neighborhood_location_type, staging_table.pl_site_area, staging_table.pl_hud_reo, staging_table.pl_energy_improvement_replacement_major_system, staging_table.pl_energy_improvement_insulation_sealant, staging_table.pl_energy_improvement_installation_solar, staging_table.pl_energy_improvement_addition_new_feature, staging_table.pl_energy_improvement_other, staging_table.pl_energy_related_repairs_or_improvements_amount, staging_table.pl_refinance_general_improvements_amount, staging_table.pl_va_guaranteed_reo, staging_table.pl_va_loan_date, staging_table.pl_gross_building_area_square_feet, staging_table.pl_project_dwelling_units_sold_count, staging_table.pl_prior_owners_title, staging_table.pl_prior_owners_title_policy_amount, staging_table.pl_prior_owners_title_policy_effective_date, staging_table.pl_prior_lenders_title, staging_table.pl_prior_lenders_title_policy_amount, staging_table.pl_prior_lenders_title_policy_effective_date, staging_table.pl_bedroom_count_unit_1, staging_table.pl_bedroom_count_unit_2, staging_table.pl_bedroom_count_unit_3, staging_table.pl_bedroom_count_unit_4, staging_table.pl_rent_amount_unit_1, staging_table.pl_rent_amount_unit_2, staging_table.pl_rent_amount_unit_3, staging_table.pl_rent_amount_unit_4, staging_table.pl_listed_for_sale_in_last_6_months, staging_table.pl_property_in_borrower_trust, staging_table.pl_road_type, staging_table.pl_water_type, staging_table.pl_sanitation_type, staging_table.pl_survey_required, staging_table.pl_solar_panels_type, staging_table.pl_power_purchase_agreement, staging_table.pl_solar_panel_provider_name, staging_table.pl_seller_acquired_date, staging_table.pl_seller_original_cost_amount, staging_table.pl_remaining_economic_life_years, staging_table.pl_bathroom_count_unit_1, staging_table.pl_bathroom_count_unit_2, staging_table.pl_bathroom_count_unit_3, staging_table.pl_bathroom_count_unit_4, staging_table.pl_total_room_count_unit_1, staging_table.pl_total_room_count_unit_2, staging_table.pl_total_room_count_unit_3, staging_table.pl_total_room_count_unit_4, staging_table.pl_gross_living_area_square_feet_unit_1, staging_table.pl_gross_living_area_square_feet_unit_2, staging_table.pl_gross_living_area_square_feet_unit_3, staging_table.pl_gross_living_area_square_feet_unit_4, staging_table.pl_mh_leasehold__property_interest_type, staging_table.pl_tribe_name, staging_table.pl_leasehold_begin_date, staging_table.pl_lease_number, staging_table.pl_property_inspection_required, staging_table.pl_hvac_inspection_required, staging_table.pl_pest_inspection_required, staging_table.pl_radon_inspection_required, staging_table.pl_septic_inspection_required, staging_table.pl_water_well_inspection_required, staging_table.pl_structural_inspection_required, staging_table.pl_pest_inspection_required_auto_compute, staging_table.pl_management_agent_federal_tax_id, staging_table.pl_mh_manufacturer_street_1, staging_table.pl_mh_manufacturer_street_2, staging_table.pl_mh_manufacturer_city, staging_table.pl_mh_manufacturer_state, staging_table.pl_mh_manufacturer_postal_code, staging_table.pl_mh_manufacturer_phone, staging_table.pl_mh_manufacturer_phone_extension, staging_table.pl_recording_city_name, staging_table.pl_abbreviated_legal_description, staging_table.pl_geocode_service_disabled, staging_table.pl_vesting_confirmed, staging_table.pl_previous_title_manner_held_description, staging_table.pl_legal_lot_na, staging_table.pl_legal_block_na, staging_table.pl_legal_section_na, staging_table.pl_legal_description_confirmed, staging_table.pl_lead_inspection_required, staging_table.pl_calculated_lead_inspection_required, staging_table.pl_geocode_system_error, staging_table.pl_mixed_use, staging_table.pl_mixed_use_verified, staging_table.pl_mixed_use_area_square_feet, staging_table.pl_mixed_use_area_square_feet_verified, staging_table.pl_mixed_use_area_percent, staging_table.pl_trust_classification_type, staging_table.pl_additional_building_area_square_feet, FALSE as data_source_deleted_flag, now() AS data_source_updated_datetime
FROM staging_octane.place staging_table
LEFT JOIN history_octane.place history_table on staging_table.pl_pid = history_table.pl_pid and staging_table.pl_version = history_table.pl_version
WHERE history_table.pl_pid is NULL
UNION ALL
SELECT history_table.pl_pid, history_table.pl_version+1, history_table.pl_proposal_pid, history_table.pl_subject_property, history_table.pl_acquisition_date, history_table.pl_construction_improvement_costs_amount, history_table.pl_financed_units_count, history_table.pl_unit_count, history_table.pl_land_estimated_value_amount, history_table.pl_land_original_cost_amount, history_table.pl_leasehold_expiration_date, history_table.pl_legal_description_type, history_table.pl_legal_description, history_table.pl_property_tax_id, history_table.pl_legal_lot, history_table.pl_legal_block, history_table.pl_legal_section, history_table.pl_project_name, history_table.pl_cpm_project_id, history_table.pl_acquisition_cost_amount, history_table.pl_county_pid, history_table.pl_sub_jurisdiction_name, history_table.pl_recording_district_name, history_table.pl_project_classification_type, history_table.pl_property_category_type, history_table.pl_property_rights_type, history_table.pl_refinance_total_improvement_costs_amount, history_table.pl_refinance_improvements_type, history_table.pl_refinance_proposed_improvements_description, history_table.pl_structure_built_year, history_table.pl_structure_built_month, history_table.pl_title_manner_held_type, history_table.pl_title_manner_held_description, history_table.pl_building_status_type, history_table.pl_construction_conversion, history_table.pl_native_american_lands_type, history_table.pl_community_land_trust, history_table.pl_inclusionary_zoning, history_table.pl_unique_dwelling_type, history_table.pl_living_unit_count, history_table.pl_project_design_type, history_table.pl_city, history_table.pl_country, history_table.pl_postal_code, history_table.pl_state, history_table.pl_street1, history_table.pl_street2, history_table.pl_street_tbd, history_table.pl_landlord_first_name, history_table.pl_landlord_last_name, history_table.pl_landlord_middle_name, history_table.pl_landlord_name_suffix, history_table.pl_landlord_company_name, history_table.pl_landlord_title, history_table.pl_landlord_office_phone, history_table.pl_landlord_office_phone_extension, history_table.pl_landlord_mobile_phone, history_table.pl_landlord_email, history_table.pl_landlord_fax, history_table.pl_landlord_city, history_table.pl_landlord_country, history_table.pl_landlord_postal_code, history_table.pl_landlord_state, history_table.pl_landlord_street1, history_table.pl_landlord_street2, history_table.pl_management_first_name, history_table.pl_management_last_name, history_table.pl_management_middle_name, history_table.pl_management_name_suffix, history_table.pl_management_company_name, history_table.pl_management_title, history_table.pl_management_office_phone, history_table.pl_management_office_phone_extension, history_table.pl_management_mobile_phone, history_table.pl_management_email, history_table.pl_management_fax, history_table.pl_management_city, history_table.pl_management_country, history_table.pl_management_postal_code, history_table.pl_management_state, history_table.pl_management_street1, history_table.pl_management_street2, history_table.pl_property_insurance_amount_input_type, history_table.pl_property_tax_amount_input_type, history_table.pl_annual_property_insurance_amount, history_table.pl_annual_property_tax_amount, history_table.pl_monthly_property_insurance_amount, history_table.pl_monthly_hoa_amount, history_table.pl_monthly_mi_amount, history_table.pl_monthly_property_tax_amount, history_table.pl_monthly_lease_ground_rent_amount, history_table.pl_monthly_rent_amount, history_table.pl_monthly_obligation_amount, history_table.pl_use_proposed_property_usage, history_table.pl_property_usage_type, history_table.pl_property_value_amount, history_table.pl_reo_disposition_status_type, history_table.pl_auto_geocode, history_table.pl_auto_geocode_exception, history_table.pl_msa_code, history_table.pl_state_fips, history_table.pl_county_fips, history_table.pl_census_tract, history_table.pl_mh_make, history_table.pl_mh_model, history_table.pl_mh_length, history_table.pl_mh_width, history_table.pl_mh_manufacturer, history_table.pl_mh_serial_number, history_table.pl_mh_hud_label_number, history_table.pl_mh_certificate_of_title_issued, history_table.pl_mh_certificate_of_title_number, history_table.pl_mh_certificate_of_title_type, history_table.pl_mh_loan_purpose_type, history_table.pl_mh_anchored, history_table.pl_coop_company_name, history_table.pl_coop_building_name, history_table.pl_coop_vacant_units, history_table.pl_coop_proprietary_lease_date, history_table.pl_coop_assignment_lease_date, history_table.pl_coop_existing_company_laws_state, history_table.pl_coop_shares_being_purchased, history_table.pl_coop_attorney_in_fact, history_table.pl_coop_stock_certificate_number, history_table.pl_coop_apartment_unit, history_table.pl_rental, history_table.pl_underwriter_comments, history_table.pl_lava_zone_type, history_table.pl_neighborhood_location_type, history_table.pl_site_area, history_table.pl_hud_reo, history_table.pl_energy_improvement_replacement_major_system, history_table.pl_energy_improvement_insulation_sealant, history_table.pl_energy_improvement_installation_solar, history_table.pl_energy_improvement_addition_new_feature, history_table.pl_energy_improvement_other, history_table.pl_energy_related_repairs_or_improvements_amount, history_table.pl_refinance_general_improvements_amount, history_table.pl_va_guaranteed_reo, history_table.pl_va_loan_date, history_table.pl_gross_building_area_square_feet, history_table.pl_project_dwelling_units_sold_count, history_table.pl_prior_owners_title, history_table.pl_prior_owners_title_policy_amount, history_table.pl_prior_owners_title_policy_effective_date, history_table.pl_prior_lenders_title, history_table.pl_prior_lenders_title_policy_amount, history_table.pl_prior_lenders_title_policy_effective_date, history_table.pl_bedroom_count_unit_1, history_table.pl_bedroom_count_unit_2, history_table.pl_bedroom_count_unit_3, history_table.pl_bedroom_count_unit_4, history_table.pl_rent_amount_unit_1, history_table.pl_rent_amount_unit_2, history_table.pl_rent_amount_unit_3, history_table.pl_rent_amount_unit_4, history_table.pl_listed_for_sale_in_last_6_months, history_table.pl_property_in_borrower_trust, history_table.pl_road_type, history_table.pl_water_type, history_table.pl_sanitation_type, history_table.pl_survey_required, history_table.pl_solar_panels_type, history_table.pl_power_purchase_agreement, history_table.pl_solar_panel_provider_name, history_table.pl_seller_acquired_date, history_table.pl_seller_original_cost_amount, history_table.pl_remaining_economic_life_years, history_table.pl_bathroom_count_unit_1, history_table.pl_bathroom_count_unit_2, history_table.pl_bathroom_count_unit_3, history_table.pl_bathroom_count_unit_4, history_table.pl_total_room_count_unit_1, history_table.pl_total_room_count_unit_2, history_table.pl_total_room_count_unit_3, history_table.pl_total_room_count_unit_4, history_table.pl_gross_living_area_square_feet_unit_1, history_table.pl_gross_living_area_square_feet_unit_2, history_table.pl_gross_living_area_square_feet_unit_3, history_table.pl_gross_living_area_square_feet_unit_4, history_table.pl_mh_leasehold__property_interest_type, history_table.pl_tribe_name, history_table.pl_leasehold_begin_date, history_table.pl_lease_number, history_table.pl_property_inspection_required, history_table.pl_hvac_inspection_required, history_table.pl_pest_inspection_required, history_table.pl_radon_inspection_required, history_table.pl_septic_inspection_required, history_table.pl_water_well_inspection_required, history_table.pl_structural_inspection_required, history_table.pl_pest_inspection_required_auto_compute, history_table.pl_management_agent_federal_tax_id, history_table.pl_mh_manufacturer_street_1, history_table.pl_mh_manufacturer_street_2, history_table.pl_mh_manufacturer_city, history_table.pl_mh_manufacturer_state, history_table.pl_mh_manufacturer_postal_code, history_table.pl_mh_manufacturer_phone, history_table.pl_mh_manufacturer_phone_extension, history_table.pl_recording_city_name, history_table.pl_abbreviated_legal_description, history_table.pl_geocode_service_disabled, history_table.pl_vesting_confirmed, history_table.pl_previous_title_manner_held_description, history_table.pl_legal_lot_na, history_table.pl_legal_block_na, history_table.pl_legal_section_na, history_table.pl_legal_description_confirmed, history_table.pl_lead_inspection_required, history_table.pl_calculated_lead_inspection_required, history_table.pl_geocode_system_error, history_table.pl_mixed_use, history_table.pl_mixed_use_verified, history_table.pl_mixed_use_area_square_feet, history_table.pl_mixed_use_area_square_feet_verified, history_table.pl_mixed_use_area_percent, history_table.pl_trust_classification_type, history_table.pl_additional_building_area_square_feet, TRUE as data_source_deleted_flag, now() AS data_source_updated_datetime
FROM history_octane.place history_table
LEFT JOIN staging_octane.place staging_table on staging_table.pl_pid = history_table.pl_pid
WHERE staging_table.pl_pid is NULL
  AND not exists (select 1 from history_octane.place deleted_records where deleted_records.pl_pid = history_table.pl_pid and deleted_records.data_source_deleted_flag = True)'
        WHERE mdi.table_input_step.process_dwid = place_config_process_dwid;
    END
$$
